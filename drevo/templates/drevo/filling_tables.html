{% extends 'drevo/base.html' %}

{% load static %}

{% block cssfiles %}
    <link rel="stylesheet" href="{% static '/drevo/css/drevo.css' %}">
{#    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">#}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.1/css/bootstrap-select.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.1/js/bootstrap-select.js"></script>
{% endblock %}

<head><title>{% block title %}Ввод табличных знаний{% endblock %}</title></head>

{% block content %}
    <form method="POST">

        {% csrf_token %}

        <h1>Ввод/изменение ячеек таблицы</h1>
        <span>Таблица:</span>
        <select  name="table" data-live-search="true" class="selectpicker" id="id_table" style="width: 180px">
            <option value="" disabled selected hidden>Выбрать таблицу</option>
            {% for pk, element in table_dict.items %}
               <option value="{{ pk }}" id="{{ pk }}"> {{ element }} </option>
            {% endfor %}
        </select>
        <h2>Координаты ячейки</h2>
        <span>Строка:</span>
        <select name="row" id="id_row" placeholder="Выбрать строку V" style="width: 180px">
            <option value="">Выбрать строку V</option>
        </select>
        <span>Столбец:</span>
        <select name="column" id="id_column" style="width: 180px">
            <option value="">Выбрать столбец V</option>
        </select>
        <br>
        <div>
            <span>Знание:</span>
           <select data-live-search="true" class="selectpicker" name="znanie" id="id_znanie" style="width: 180px">
               <option value="" disabled selected hidden>Выбрать знание V</option>
                {% for zn in znanie %}
                    <option value="{{ zn.id }}" id="{{ zn.id }}"> {{ zn.name }} </option>
                {% endfor %}
            </select>
            <a id="add-znanie" onclick=winOpen()>
                <img src="{% static 'drevo/img/knowledge_search/plus.svg' %}" height="20px">
            </a>
        </div>
        </br>
        <h2 class="">Параметры ячейки</h2>
        <span>Вид знания:</span>
        <div id="id_view" >
            <input readonly style="width: 180px" type="text">
        </div>
        <div>
            <span>Автор:</span>
            <div id="id_author">
                <input name="author" id="id_author" readonly style="width: 180px" type="text">
            </div>
        </div>
        <div id="znanie_content"><span name="">Содержание знания:</span></div>
        <div id="text_id">
            <input class="text-show" value="" name="name" readonly style="width: 180px" type="text">
        </div>
        </br>
        <input type="submit" value="Сохранить" name="_save">
    </form>
    <button id="btn_show"> Показать</button>
    <div id="div1"></div>

    <script>
        let table_choice = document.getElementById("id_table")
        let row_choice = document.getElementById("id_row")
        let column_choice = document.getElementById("id_column")

        let znanie_choice = document.getElementById("id_znanie")
        let view_choice = document.getElementById("id_view")
        let author_choice = document.getElementById("id_author")
        let author_add = document.getElementById("author_add")
        let content_znanie = document.getElementById("znanie_content")
        let btn_show = document.getElementById("btn_show")
        text_show = document.getElementById("text_id")

        $(document).ready(function() {
            $('.js-example-basic-single').select2();
        });
        const csrftoken = getCookie('csrftoken');
        var tab;
        function winOpen() {
            tab = window.open('/admin/drevo/znanie/add/', 'tab', 'Toolbar=1,Location=0,Directories=0,Status=0,Menubar=0,Scrollbars=0,Resizable=0,Width=550,Height=400')
            function newZnanie() {
                const data = {};
                let url = "{% url 'show_new_znanie' %}"

                fetch(url, {
                   method: 'POST',
                   headers: {
                       'Content-Type': 'application/json',
                       'X-CSRFToken': csrftoken
                   },
                    body: JSON.stringify(data),
                })
                .then(response => response.json())
                .then(data => {
                    znanie_choice.innerHTML = `<option value="${data[0]}" selescted>${data[1]}</option>`
                    getZnanieId(data[0])
                })
                .catch((error) => {
                console.log('Error:', error);
                });
            }
        }

        function getCookie(name) {
           let cookieValue = null;
           if (document.cookie && document.cookie !== '') {
               const cookies = document.cookie.split(';');
               for (let i = 0; i < cookies.length; i++) {
                   const cookie = cookies[i].trim();
                   if (cookie.substring(0, name.length + 1) === (name + '=')) {
                       cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                       break;
                   }
               }
           }
           return cookieValue;
        }

        btn_show.addEventListener("click", function () {
            var id = znanie_choice.value
            if (id) {
                window.location.href = "{% url 'zdetail' pk='1' %}".replace(/1/, id.toString());
            }
        });
        znanie_choice.addEventListener("change", getZnanieId)
        table_choice.addEventListener("change", getTableId);

        function getZnanieId(e) {
            if (typeof (e) != "number") {
                var znanie_id = e.target.value;
            }
            else {
                var znanie_id = e
            }
           const data = { id: znanie_id};
            let url = "{% url 'znanie_attributes' %}"

            fetch(url, {
               method: 'POST',
               headers: {
                   'Content-Type': 'application/json',
                   'X-CSRFToken': csrftoken
               },
                body: JSON.stringify(data),
            })
            .then(response => response.json())
            .then(data => {
                view_choice.innerHTML = `<input value = "${data[0]}" readonly>`
                author_choice.innerHTML = `<input value = "${data[1]}" readonly>`
                if (data[2]) {
                    content_znanie.innerHTML = `<span name="">Содержание знания:</span>`
                    text_show.innerHTML = `<input id="id_text" class="text-show" value = "${data[2]}" readonly>`
                }
                else {
                    content_znanie.innerHTML = ``
                    text_show.innerHTML =``
                }
            })
            .catch((error) => {
            console.log('Error:', error);
            });
        }

        function getTableId(e) {
           let table_id = e.target.value
           const data = { id: table_id};
           let url = "{% url 'get_rows_and_columns' %}"

            fetch(url, {
               method: 'POST',
               headers: {
                   'Content-Type': 'application/json',
                   'X-CSRFToken': csrftoken
               },
                body: JSON.stringify(data),
            })
            .then(response => response.json())
            .then(data => {
                let rows = data[0]
                let r_keys = Object.keys(rows)
                if (r_keys.length === 0) {
                    row_choice.innerHTML = `<option value="" selected="true" disabled>Строки отсутствуют</option>`
                }
                else {
                    row_choice.innerHTML = `<option value="${rows[0]['rz_id']}" selescted>${rows[0]['rz__name']}</option>`
                    for(let i = 1; i<r_keys.length; i++){
                      row_choice.innerHTML += `<option value = "${rows[i]['rz_id']}" selescted>${rows[i]['rz__name']}</option>`
                    }
                }

                let columns = data[1]
                let c_keys = Object.keys(columns)
                if (c_keys.length === 0) {
                    column_choice.innerHTML = `<option value="" selected="true" disabled >Столбцы отсутствуют</option>`
                }
                else {
                    column_choice.innerHTML = `<option value="${columns[0]['rz_id']}" selescted>${columns[0]['rz__name']}</option>`
                    for(let i = 1; i<c_keys.length; i++){
                      column_choice.innerHTML += `<option value="${columns[i]['rz_id']}" selescted>${columns[i]['rz__name']}</option>`
                    }
                }
             })
            .catch((error) => {
            console.log('Error:', error);
            });
         }

    </script>
    <style>
        .text-show{
            width: 450px;
            height: 150px;
        }
    </style>

{% endblock %}